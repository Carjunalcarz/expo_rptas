# Appwrite Database Setup Guide

This guide will help you set up your Appwrite database for the RPTAS mobile application.

## Prerequisites

1. **Appwrite Server**: Make sure you have Appwrite running (cloud or self-hosted)
2. **API Key**: You need an API key with admin permissions
3. **Environment Variables**: Configure your `.env` file

## Step 1: Configure Environment Variables

Create or update your `.env` file with the following variables:

```env
# Appwrite Configuration
EXPO_PUBLIC_APPWRITE_ENDPOINT=https://your-appwrite-endpoint.com/v1
EXPO_PUBLIC_APPWRITE_PROJECT_ID=your-project-id
APPWRITE_API_KEY=your-admin-api-key

# Database IDs (will be generated if not provided)
EXPO_PUBLIC_APPWRITE_DATABASE_ID=rptas-database
EXPO_PUBLIC_APPWRITE_ASSESSMENTS_COLLECTION_ID=assessments

# Storage
EXPO_PUBLIC_APPWRITE_BUCKET_ID=your-bucket-id
```

### How to get these values:

1. **Endpoint**: Your Appwrite server URL (e.g., `https://cloud.appwrite.io/v1`)
2. **Project ID**: Create a project in Appwrite console and copy the ID
3. **API Key**: Go to your project settings → API Keys → Create new key with admin scope
4. **Database/Collection IDs**: These will be auto-generated by the setup script

## Step 2: Run Database Setup

This creates the database structure (collections, attributes, indexes):

```bash
npm run appwrite:setup
```

The script will:
- ✅ Create the main database
- ✅ Create the assessments collection
- ✅ Create all necessary attributes (owner details, location, assessment data)
- ✅ Create indexes for better query performance
- ✅ Set up proper permissions

## Step 3: Seed Sample Data (Optional)

Add sample assessment data to test your setup:

```bash
npm run appwrite:seed
```

This will create 3 sample assessments with realistic data including:
- Different property types (residential, commercial)
- Various locations in Metro Manila
- Complete assessment details
- Proper JSON structure

## Step 4: Verify Setup

1. **Check Appwrite Console**: 
   - Go to your Appwrite console
   - Navigate to Databases → RPTAS
   - Verify the assessments collection exists
   - Check that sample data is present (if you ran the seed script)

2. **Test in Mobile App**:
   - Run your mobile app
   - Try creating a new assessment
   - Verify that document IDs are properly saved
   - Check the assessment list shows both local and remote assessments

## Troubleshooting

### Common Issues:

1. **"Missing required environment variables"**
   - Make sure all variables in `.env` are set correctly
   - Restart your development server after changing `.env`

2. **"Failed to create database"**
   - Check your API key has admin permissions
   - Verify your Appwrite endpoint is correct and accessible
   - Make sure your project ID is valid

3. **"Attribute already exists"**
   - This is normal - the script skips existing attributes
   - Safe to re-run the setup script multiple times

4. **"Rate limiting"**
   - The scripts include delays to avoid rate limits
   - If you hit limits, wait a few minutes and try again

### Manual Verification:

You can manually check your setup using the Appwrite console:

1. **Database Structure**:
   ```
   RPTAS Database
   ├── assessments (collection)
   │   ├── Attributes: ownerName, barangay, municipality, etc.
   │   ├── JSON Fields: owner_details, building_location, etc.
   │   └── Indexes: location, owner, transaction codes
   ```

2. **Sample Data**: Should see 3 assessments if you ran the seed script

3. **Permissions**: Collections should allow read/write for authenticated users

## Next Steps

After successful setup:

1. **Test Document ID Saving**: 
   - Create assessments in your mobile app
   - Verify they sync properly to Appwrite
   - Check that local and remote IDs are maintained

2. **Test the Fix**: 
   - The `markAssessmentSynced` function should now properly update local records instead of deleting them
   - Local assessments should maintain their connection to remote documents

3. **Monitor Sync Status**: 
   - Use the assessment detail screen to verify sync status
   - Check the "Record Information" section shows correct IDs

## Scripts Reference

- `npm run appwrite:setup` - Create database structure
- `npm run appwrite:seed` - Add sample data
- `npm run appwrite:fix-storage-perms` - Fix storage permissions (if needed)

## Support

If you encounter issues:

1. Check the Appwrite console for error details
2. Verify your environment variables
3. Make sure your API key has the correct permissions
4. Check the console logs for detailed error messages
